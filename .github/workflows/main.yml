on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arch-pkg:
    name: Build Arch package with makepkg
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gnupg and arch keyring and initialize pacman keys
        run: |
          set -euo pipefail
          # Install gnupg and the keyring package so pacman-key can run
          pacman -Sy --noconfirm --noprogressbar gnupg archlinux-keyring || true

          # Initialize and populate pacman keyring. In CI this can be flaky due to low entropy;
          # allow these to fail non-fatally and continue to refresh DB below.
          pacman-key --init || true
          pacman-key --populate archlinux || true

          # Refresh package database after keyring/populate
          pacman -Sy --noconfirm --noprogressbar

      - name: Sync pacman DB and upgrade system
        run: |
          pacman -Syu --noconfirm --noprogressbar

      - name: Install required packages (if available)
        run: |
          set -euo pipefail
          # base-devel is required for makepkg
          PKGS="base-devel git clang cmake ninja ispc ffmpeg openal sdl2 glu vulkan-headers vulkan-icd-loader mesa python"
          for p in $PKGS; do
            if pacman -Si "$p" >/dev/null 2>&1; then
              pacman -S --noconfirm --needed "$p"
            else
              echo "Package $p not found in repos; skipping"
            fi
          done

          # directx shader compiler package name may vary between 'directx-shader-compiler' and 'dxc'
          if pacman -Si directx-shader-compiler >/dev/null 2>&1; then
            pacman -S --noconfirm --needed directx-shader-compiler
          elif pacman -Si dxc >/dev/null 2>&1; then
            pacman -S --noconfirm --needed dxc
          else
            echo "DXC not in repos; if you need it, install it manually or add an AUR step"
          fi

      - name: Create build user (makepkg must NOT run as root)
        run: |
          set -euo pipefail
          useradd -m builder
          # Ensure the GitHub workspace exists inside the container and is owned by builder
          WORKSPACE="${GITHUB_WORKSPACE:-/github/workspace}"
          mkdir -p "$WORKSPACE"
          chown -R builder:builder "$WORKSPACE"

      - name: Run makepkg (build the package)
        run: |
          set -euo pipefail
          WORKSPACE="${GITHUB_WORKSPACE:-/github/workspace}"
          # run as the non-root 'builder' user; ensure we run in the workspace
          su builder -c "cd '$WORKSPACE' && makepkg -s --noconfirm --skippgpcheck"
        env:
          # ensure git submodules can be fetched if your PKGBUILD relies on network
          GIT_SSL_NO_VERIFY: "false"

      - name: Upload built package artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: |
            *.pkg.tar.zst
            *.pkg.tar.xz
            *.pkg.tar.gz
